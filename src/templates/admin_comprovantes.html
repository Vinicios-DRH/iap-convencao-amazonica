{% extends 'base.html' %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body {
        background: linear-gradient(120deg, #e0e7ff, #fef3c7, #ffe4e6);
        background-size: 600% 600%;
        animation: gradientBG 15s ease infinite;
        font-family: 'Montserrat', sans-serif;
        min-height: 100vh;
    }

    @keyframes gradientBG {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }


    .container {
        padding-top: 40px;
        max-width: 1200px;
    }

    h2 {
        font-weight: bold;
        text-transform: uppercase;
        color: #333;
    }

    .table thead {
        background: linear-gradient(135deg, #6e00ff, #ff4d00);
        color: white;
    }

    .btn-aprovar {
        background-color: #28a745;
        color: white;
    }

    .btn-rejeitar {
        background-color: #dc3545;
        color: white;
    }

    .btn-ver {
        background-color: #007bff;
        color: white;
    }

    .btn-exportar {
        background: linear-gradient(135deg, #6e00ff, #ff4d00);
        color: white;
        font-weight: bold;
    }

    .btn-logout {
        background: #343a40;
        color: white;
        font-weight: bold;
        border-radius: 30px;
        padding: 6px 18px;
        text-decoration: none;
    }

    .btn-logout:hover {
        background: #000;
        color: #ffc107;
    }

    .badge-aprovado {
        background-color: #28a745;
    }

    .badge-rejeitado {
        background-color: #dc3545;
    }

    .badge-pendente {
        background-color: #ffc107;
        color: black;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="admin-header">
        <h2>Painel Administrativo - Comprovantes</h2>
        <a href="{{ url_for('logout') }}" class="btn btn-logout">Sair</a>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="filtro-nome" class="form-control" placeholder="Filtrar por nome...">
        </div>
        <div class="col-md-4">
            <select id="filtro-status" class="form-select">
                <option value="">Todos os Status</option>
                <option value="Aprovado">Aprovado</option>
                <option value="Rejeitado">Rejeitado</option>
                <option value="Pendente">Pendente</option>
            </select>
        </div>
    </div>


    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-end mb-3">
        <a href="{{ url_for('exportar_comprovantes') }}" class="btn btn-exportar">Exportar Excel</a>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Parcela</th>
                    <th>Data</th>
                    <th>Arquivo</th>
                    <th>Status</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for comp in comprovantes %}
                <tr>
                    <td>{{ comp.usuario.nome }}</td>
                    <td>{{ comp.usuario.email }}</td>
                    <td>{{ comp.parcela }}</td>
                    <td>{{ comp.data_envio.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        <a class="btn btn-ver btn-sm"
                            href="https://supabase.co/storage/v1/object/public/comprovantes/{{ comp.id_user }}/{{ comp.arquivo_comprovante }}"
                            target="_blank">Ver</a>


                    </td>
                    <td>
                        {% if comp.status == 'Aprovado' %}
                        <span class="badge badge-aprovado">Aprovado</span>
                        {% elif comp.status == 'Rejeitado' %}
                        <span class="badge badge-rejeitado">Rejeitado</span>
                        {% else %}
                        <span class="badge badge-pendente">Pendente</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" action="{{ url_for('atualizar_comprovante', id=comp.id) }}">
                            <div class="d-flex gap-2">
                                <input type="hidden" name="status" value="Aprovado">
                                <button class="btn btn-aprovar btn-sm" type="submit">Aprovar</button>
                        </form>
                        <form method="POST" action="{{ url_for('atualizar_comprovante', id=comp.id) }}">
                            <input type="hidden" name="status" value="Rejeitado">
                            <button class="btn btn-rejeitar btn-sm" type="submit">Rejeitar</button>
                        </form>
    </div>
    </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
</div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const inputNome = document.getElementById("filtro-nome");
        const selectStatus = document.getElementById("filtro-status");
        const linhas = document.querySelectorAll("tbody tr");

        function filtrar() {
            const nomeFiltro = inputNome.value.toLowerCase();
            const statusFiltro = selectStatus.value.toLowerCase();

            linhas.forEach(linha => {
                const nome = linha.children[0].innerText.toLowerCase();
                const status = linha.children[5].innerText.trim().toLowerCase();

                const nomeCond = nome.includes(nomeFiltro);
                const statusCond = statusFiltro === "" || status === statusFiltro;

                linha.style.display = nomeCond && statusCond ? "" : "none";
            });
        }

        inputNome.addEventListener("keyup", filtrar);
        selectStatus.addEventListener("change", filtrar);
    });
</script>

{% endblock %}